name: Publish to npm and create GitHub Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish, e.g. 1.2.3"
        required: true
        type: string
      prerelease:
        description: "Mark GitHub Release as prerelease"
        required: true
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Upgrade npm
        run: npm i -g npm@latest

      - name: Install dependencies
        run: npm ci

      - name: Validate version
        run: |
          VERSION="${{ inputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid semver: $VERSION"
            exit 1
          fi

      - name: Check version does not already exist on npm
        run: |
          PKG_NAME=$(node -p "require('./package.json').name")
          VERSION="${{ inputs.version }}"
          if npm view "${PKG_NAME}@${VERSION}" version >/dev/null 2>&1; then
            echo "Version ${PKG_NAME}@${VERSION} already exists on npm"
            exit 1
          fi

      - name: Update package version locally
        run: npm version "${{ inputs.version }}" --no-git-tag-version

      - name: Show package info
        run: |
          node -e "const p=require('./package.json'); console.log('Publishing:', p.name, p.version)"

      - name: Build
        run: npm run build --if-present

      - name: Publish to npm
        run: npm publish --provenance

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ inputs.version }}"
          TAG="v$VERSION"

          EXTRA_ARGS=""
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            EXTRA_ARGS="--prerelease"
          fi

          gh release create "$TAG" \
            --target "${{ github.sha }}" \
            --title "$TAG" \
            --generate-notes \
            $EXTRA_ARGS